apiVersion: core.oam.dev/v1beta1
kind: WorkflowStepDefinition
metadata:
  annotations:
    definition.oam.dev/alias: ""
    definition.oam.dev/description: Send request to the url
  name: request
  namespace: vela-system
spec:
  schematic:
    cue:
      template: |
        import (
                "vela/op"
                "encoding/json"
        )

        http: op.http.#Do & {
                method: parameter.method
                url:    parameter.url
                request: {
                        if parameter.body != _|_ {
                                body: json.Marshal(parameter.body)
                        }
                        if parameter.header != _|_ {
                                header: parameter.header
                        }
                }
        }
        fail: op.#Steps & {
          if http.response.statusCode > 400 {
            requestFail: op.#Fail & {
              message: "Request to \(parameter.url) failed with status code: \(http.response.statusCode)"
            }
          }
        }

        // Safely unmarshal the response body if it's defined
        response?: {
          if http.response.body != _|_ {
            decoded: json.Unmarshal(bytes(http.response.body))
          }
        }

        // Output the raw response body for debugging
        output: http.response.body

        // Input parameters
        parameter: {
                url:    string
                method: *"GET" | "POST" | "PUT" | "DELETE"
                body?: {...}
                header?: [string]: string
        }